<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cloudflare Pages & Workers Demo</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f3f3f3;
      color: #111;
      margin: 0;
      min-height: 100vh;
    }
    header {
      padding: 2rem 1.5rem;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }
    main {
      padding: 2rem 1.5rem;
      max-width: 960px;
      margin: 0 auto;
    }
    header {
      position: relative;
    }
    header a {
      color: inherit;
      text-decoration: none;
    }
    header a:hover {
      text-decoration: underline;
    }
    .articles {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    article {
      background: #fff;
      padding: 2rem;
      border: 1px solid #e2e2e2;
      border-radius: 6px;
      box-shadow: 0 10px 30px rgba(50, 50, 93, 0.08);
    }
    article h2 {
      margin-top: 0;
      font-size: 1.5rem;
      border-bottom: 1px solid #e2e2e2;
      padding-bottom: 0.75rem;
    }
    article p {
      color: #555;
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }
    .preview {
      margin-top: 1.5rem;
      line-height: 1.7;
    }
    .preview :is(h1, h2, h3, h4) {
      color: #111;
      margin-top: 1.5rem;
    }
    .preview :is(p, li, blockquote) {
      color: #333;
    }
    @media (max-width: 600px) {
      article {
        padding: 1.5rem;
      }
    }
    .pagination {
      display: flex;
      justify-content: center;
      background: transparent;
      padding: 1rem 0;
    }
    .pagination-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: #fff;
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      border: 1px solid #e2e8f0;
    }
    .category-tabs {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 0 0.5rem;
      flex-wrap: wrap;
    }
    .category-tabs button {
      border: 1px solid transparent;
      background: #fff;
      color: #475569;
      padding: 0.45rem 1.25rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(15, 23, 42, 0.08);
      transition: border-color 0.15s ease, color 0.15s ease, transform 0.15s ease;
    }
    .category-tabs button.active {
      border-color: #1d4ed8;
      color: #1d4ed8;
      transform: translateY(-1px);
    }
    .pagination button {
      border: none;
      background: #1d4ed8;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 5px 12px rgba(30, 64, 175, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .pagination button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.45);
    }
    .pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }
    .page-numbers {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
      gap: 0.5rem;
    }
    .page-numbers li {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #475569;
      background: #f8fafc;
      border: 1px solid transparent;
      cursor: default;
    }
    .page-numbers li.active {
      background: #1d4ed8;
      color: #fff;
      border-color: #1d4ed8;
    }
    .post-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.75rem;
    }
    .post-actions button {
      border: 1px solid #1a73e8;
      background: #1a73e8;
      color: #fff;
      padding: 0.4rem 1rem;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
    }
    .post-actions button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <h1><a id="home-link" href="/">Markdown-it Preview</a></h1>
    <p>Live-rendered Markdown powered by <code>markdown-it</code>.</p>
  </header>
  <main>
    <section class="category-tabs" id="category-tabs" aria-label="Post categories"></section>
    <nav class="pagination" aria-label="Article pagination">
      <div class="pagination-card">
        <button type="button" id="prev-page" aria-label="Previous page">Previous</button>
        <ul class="page-numbers" id="page-numbers-top" role="list"></ul>
        <button type="button" id="next-page" aria-label="Next page">Next</button>
      </div>
    </nav>
    <section class="articles" id="markdown-list" aria-live="polite"></section>
    <nav class="pagination" aria-label="Article pagination">
      <div class="pagination-card">
        <button type="button" id="prev-page-bottom" aria-label="Previous page">Previous</button>
        <ul class="page-numbers" id="page-numbers-bottom" role="list"></ul>
        <button type="button" id="next-page-bottom" aria-label="Next page">Next</button>
      </div>
    </nav>
  </main>
  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get('hello') === '1') {
        document.body.innerHTML = `
          <header style="padding:2rem;text-align:center;background:#111;color:#fff;">
            <h1>Hello World Test</h1>
            <p>Pages + Workers are wired. Reload without <code>?hello=1</code> to return to the normal feed.</p>
          </header>
          <main style="padding:2rem;text-align:center;">
            <p>This page demonstrates a minimal build while debugging the Cloudflare preview.</p>
            <p><a href="/" style="color:#1d4ed8;font-weight:600;">Back to the demo</a></p>
          </main>`;
        window.__helloMode = true;
      }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  <script>
    if (window.__helloMode) {
      return;
    }
    const manifestUrl = 'content/posts/manifest.json';
    const container = document.getElementById('markdown-list');
    const categoryTabs = document.getElementById('category-tabs');
    const md = window.markdownit({ html: false, linkify: true });
    const pagination = {
      prev: document.getElementById('prev-page'),
      next: document.getElementById('next-page'),
      bottomPrev: document.getElementById('prev-page-bottom'),
      bottomNext: document.getElementById('next-page-bottom'),
      topList: document.getElementById('page-numbers-top'),
      bottomList: document.getElementById('page-numbers-bottom'),
    };
    const POSTS_PER_PAGE = 5;
    let categories = [];
    let defaultPosts = [];
    let selectedCategory = null;
    let currentPage = 1;
    const pageByCategory = {};
    let defaultPage = 1;

    const createCard = (post) => {
      const card = document.createElement('article');
      card.className = 'post';
      const title = document.createElement('h2');
      title.textContent = post.title;
      const description = document.createElement('p');
      description.textContent = `Published ${new Date(post.date).toLocaleDateString()}`;
      const preview = document.createElement('div');
      preview.className = 'preview';
      const actions = document.createElement('div');
      actions.className = 'post-actions';
      const button = document.createElement('button');
      button.type = 'button';
      button.textContent = 'Read full article';
      actions.append(button);
      card.append(title, description, preview, actions);
      return { card, preview, button };
    };

    const renderExcerpt = (post, preview) => {
      const excerptText = post.excerpt || 'No preview available.';
      preview.innerHTML = md.render(excerptText);
      preview.style.color = '';
      preview.dataset.mode = 'excerpt';
    };

    const loadFullArticle = async (post, preview, button) => {
      if (preview.dataset.fullContent) {
        return preview.dataset.fullContent;
      }
      button.disabled = true;
      button.textContent = 'Loading full articleâ€¦';
      try {
        const response = await fetch(`content/posts/${post.file}`);
        if (!response.ok) {
          throw new Error(`status ${response.status}`);
        }
        const markdown = await response.text();
        preview.dataset.fullContent = markdown;
        return markdown;
      } finally {
        button.disabled = false;
      }
    };

    const toggleContent = async (post, preview, button) => {
      if (preview.dataset.mode === 'full') {
        renderExcerpt(post, preview);
        button.textContent = 'Read full article';
        return;
      }
      try {
        const markdown = await loadFullArticle(post, preview, button);
        preview.innerHTML = md.render(markdown);
        preview.style.color = '';
        preview.dataset.mode = 'full';
        button.textContent = 'Show summary';
      } catch (error) {
        preview.textContent = `Failed to load ${post.file}: ${error.message}`;
        preview.style.color = '#f87171';
        button.textContent = 'Try again';
      }
    };

    const renderPageNumbers = (list, totalPages, active) => {
      if (!list) return;
      list.innerHTML = '';
      for (let i = 1; i <= totalPages; i += 1) {
        const item = document.createElement('li');
        item.textContent = i.toString();
        if (i === active) {
          item.classList.add('active');
          item.setAttribute('aria-current', 'page');
        }
        item.addEventListener('click', () => renderPage(i));
        list.append(item);
      }
    };

    const renderCategoryTabs = () => {
      if (!categoryTabs) {
        return;
      }
      categoryTabs.innerHTML = '';
      categories.forEach((category) => {
        const button = document.createElement('button');
        button.type = 'button';
        const directoryName = category.directory || category.slug;
        button.textContent = directoryName;
        button.dataset.slug = category.slug;
        if (category.slug === selectedCategory) {
          button.classList.add('active');
          button.setAttribute('aria-current', 'true');
        }
        button.addEventListener('click', () => {
          selectedCategory = selectedCategory === category.slug ? null : category.slug;
          renderCategoryTabs();
          const nextPage = selectedCategory
            ? pageByCategory[selectedCategory] || 1
            : defaultPage;
          renderPage(nextPage);
        });
        categoryTabs.append(button);
      });
    };

    const renderPage = (page = 1) => {
      const activeCategory = categories.find((cat) => cat.slug === selectedCategory);
      const posts = activeCategory ? activeCategory.posts : defaultPosts;
      const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));
      currentPage = Math.min(Math.max(page, 1), totalPages);
      if (activeCategory) {
        pageByCategory[activeCategory.slug] = currentPage;
      } else {
        defaultPage = currentPage;
      }
      container.innerHTML = '';
      const start = (currentPage - 1) * POSTS_PER_PAGE;
      const slice = posts.slice(start, start + POSTS_PER_PAGE);
      if (slice.length === 0) {
        container.innerHTML = '<article class="post"><h2>No posts</h2><p>There are no posts to show.</p></article>';
      } else {
        slice.forEach((post) => {
          const { card, preview, button } = createCard(post);
          container.append(card);
          renderExcerpt(post, preview);
          button.addEventListener('click', () => toggleContent(post, preview, button));
        });
      }
      const prevDisabled = currentPage === 1;
      const nextDisabled = currentPage === totalPages;
      [pagination.prev, pagination.bottomPrev].forEach((btn) => {
        btn.disabled = prevDisabled;
      });
      [pagination.next, pagination.bottomNext].forEach((btn) => {
        btn.disabled = nextDisabled;
      });
      renderPageNumbers(pagination.topList, totalPages, currentPage);
      renderPageNumbers(pagination.bottomList, totalPages, currentPage);
      const url = new URL(window.location);
      if (activeCategory) {
        url.searchParams.set('category', activeCategory.slug);
      } else {
        url.searchParams.delete('category');
      }
      url.searchParams.set('page', currentPage);
      window.history.replaceState({}, '', url);
    };

    pagination.prev.addEventListener('click', () => renderPage(currentPage - 1));
    pagination.next.addEventListener('click', () => renderPage(currentPage + 1));
    pagination.bottomPrev.addEventListener('click', () => renderPage(currentPage - 1));
    pagination.bottomNext.addEventListener('click', () => renderPage(currentPage + 1));
    const homeLink = document.getElementById('home-link');
    if (homeLink) {
      homeLink.addEventListener('click', (event) => {
        event.preventDefault();
        selectedCategory = null;
        renderCategoryTabs();
        renderPage(defaultPage);
      });
    }

    const handleManifestError = (error) => {
      container.innerHTML = `<article class="post"><h2>Error</h2><p>Unable to load posts: ${error.message}</p></article>`;
      [pagination.prev, pagination.bottomPrev].forEach((btn) => {
        btn.disabled = true;
      });
      [pagination.next, pagination.bottomNext].forEach((btn) => {
        btn.disabled = true;
      });
      [pagination.topList, pagination.bottomList].forEach((list) => {
        if (list) {
          list.innerHTML = '';
        }
      });
      if (categoryTabs) {
        categoryTabs.innerHTML = '';
      }
    };

    const handleManifestSuccess = (manifest) => {
      defaultPosts = Array.isArray(manifest.default?.posts) ? manifest.default.posts : [];
      if (!Array.isArray(manifest.categories)) {
        throw new Error('invalid manifest');
      }
      categories = manifest.categories;
      const params = new URLSearchParams(window.location.search);
      const requestedCategory = params.get('category');
      selectedCategory = categories.some((cat) => cat.slug === requestedCategory)
        ? requestedCategory
        : null;
      renderCategoryTabs();
      const pageParam = Number(params.get('page') || 1);
      const startingPage = selectedCategory
        ? pageByCategory[selectedCategory] || pageParam
        : defaultPage || pageParam;
      renderPage(startingPage);
    };

    fetch(manifestUrl)
      .then((res) => {
        if (!res.ok) {
          throw new Error(`status ${res.status}`);
        }
        return res.json();
      })
      .then(handleManifestSuccess)
      .catch(handleManifestError);
  </script>
</body>
</html>
